DROP TABLE CUSTOMER;
DROP TABLE CGRADE; 

CREATE TABLE CGRADE (
	GNO NUMBER(2) PRIMARY KEY,
	GRADE VARCHAR2(10) NOT NULL,
    LOW NUMBER(10,0),
    HIGH NUMBER(10,0)
);

CREATE TABLE CUSTOMER (
    CNO VARCHAR2(4) PRIMARY KEY,
    CTEL VARCHAR2(20) NOT NULL, 
    CNAME VARCHAR2(30) NOT NULL,
    POINT NUMBER(10) DEFAULT 1000, 
    BUY NUMBER(30) DEFAULT 0,
    GNO NUMBER(2)  DEFAULT 1 REFERENCES CGRADE(GNO)
);


-- 시퀀스 값 리셋하기
DROP SEQUENCE SEQ_CNO;
CREATE SEQUENCE SEQ_CNO MAXVALUE 9999;
SELECT LAST_NUMBER FROM USER_SEQUENCES WHERE SEQUENCE_NAME = 'SEQ_CNO';
--1. SEQ_CNO 시퀀스의 마지막 번호를 출력한다.
SELECT LAST_NUMBER FROM USER_SEQUENCES WHERE SEQUENCE_NAME = 'SEQ_CNO';

--2. 출력된 마지막 번호를 기준으로 값을 음수로 증가해준다. (마지막값이 3이라면 -3)
ALTER SEQUENCE SEQ_CNO INCREMENT BY -3 MINVALUE 1;

--3. 시퀀스의 증가값을 출력해본다.
SELECT SEQ_CNO.NEXTVAL FROM DUAL;

--4. 시퀀스의 현제값을 출력해본다.
SELECT SEQ_CNO.CURRVAL FROM DUAL;

--5. 시퀀스의 증가값을 1로 설정한다.
ALTER SEQUENCE SEQ_CNO INCREMENT BY 1;

--6. 데이터베이스에 적용한다.
COMMIT;

-- TABLE의 모든 값을 출력해본다.
SELECT * FROM CGRADE;
SELECT * FROM CUSTOMER;

-- 등급 정보를 테이블에 입력한다. (등급의 구간이 된다.)
INSERT INTO CGRADE VALUES (1, '일반', 0, 99999);
INSERT INTO CGRADE VALUES (2, '실버', 100000, 199999);
INSERT INTO CGRADE VALUES (3, '골드', 200000, 299999);
INSERT INTO CGRADE VALUES (4, 'VIP',  300000, 399999);
INSERT INTO CGRADE VALUES (5, 'VVIP', 400000, 9999999999);


-- 고객 정보를 CUSTOMER 테이블에 입력한다.
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-9999', '이데이', 1000, 0, 1);
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-8888', '이만화', 1000, 0, 1);
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-7777', '이레오', 1000, 0, 1);
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-6666', '손오공', 1000, 0, 1);
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-5555', '프리저', 1000, 0, 1);
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-4444', '베지터', 1000, 0, 1);

COMMIT;

UPDATE CUSTOMER SET CNO = ROWNUM; -- 고객번호를 행의 갯수로 설정한다.

-- 등급을 출력해본다.
SELECT GRADE FROM CGRADE;

-- 1. 고객 연락처로 고객정보 출력
SELECT C.*, G.GRADE, NVL((SELECT HIGH-BUY+1 from CUSTOMER WHERE CNO = C.CNO and GNO != 5), 0) LEVELUP
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO AND SUBSTR(CTEL, -4) = '6666';

SELECT C.*, G.GRADE, NVL((SELECT HIGH-BUY+1 from CUSTOMER WHERE CNO = C.CNO and GNO != 5), 0) LEVELUP
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO AND CTEL LIKE '%6666';

-- 2. 고객이름으로 고객정보출력

SELECT C.*, G.GRADE, NVL((SELECT HIGH-BUY+1 from CUSTOMER WHERE CNO = C.CNO and GNO != 5), 0) LEVELUP
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO AND CNAME = '손오공';

-- 3. 포인트로 구매 기능 - 포인트가 구매금액 이상일때만 구매 가능
SELECT POINT FROM CUSTOMER WHERE CTEL LIKE '%'||'6666' OR CNAME = '손오공';

UPDATE CUSTOMER SET BUY = (BUY + 500), POINT = (POINT - 500) WHERE CTEL LIKE '%'||'6666' OR CNAME = '손오공';

-- 4. 상품구매 - 구매금액의 5% 를 포인트로 적립. 
UPDATE CUSTOMER SET POINT = POINT + (10000 * 0.05), BUY = (BUY + 10000) WHERE CTEL LIKE '%'||'6666' OR CNAME = '손오공';

-- 구매가 일어난후에 등급을 조정할지를 서브쿼리로 확인후 등급수정
SELECT G.GNO FROM CUSTOMER C, CGRADE G WHERE BUY BETWEEN LOW AND HIGH AND CTEL LIKE '%'||'6666';

UPDATE CUSTOMER SET GNO = (SELECT G.GNO FROM CUSTOMER C, CGRADE G
                            WHERE BUY BETWEEN LOW AND HIGH AND CTEL LIKE '%'||'6666')
                WHERE CTEL LIKE '%'||'6666';

-- 5. 등급별 출력.
SELECT C.*, G.GRADE
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO AND G.GRADE = '일반'
ORDER BY CNO;

SELECT C.*, G.GRADE, NVL((SELECT HIGH-BUY+1 from CUSTOMER WHERE CNO = C.CNO and GNO != 5), 0) LEVELUP
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO AND G.GRADE = '일반' 
ORDER BY CNO;

-- 6. 전체출력
SELECT C.*, G.GRADE, NVL((SELECT HIGH-BUY+1 from CUSTOMER WHERE CNO = C.CNO and GNO != 5), 0) LEVELUP
FROM CUSTOMER C, CGRADE G
WHERE C.GNO = G.GNO
ORDER BY C.CNO;

-- 7. 회원가입
INSERT INTO CUSTOMER VALUES (SEQ_CNO.NEXTVAL, '010-9999-7890', '이나라', 1000, 0, 1);

-- 8. 이름을 기준으로 전화번호 수정
UPDATE CUSTOMER SET CTEL = '010-8888-9999' WHERE CNAME = '손오공';

-- 9.회원탈퇴
DELETE FROM CUSTOMER WHERE CTEL = '7890' OR CNAME = '이나라';

COMMIT;